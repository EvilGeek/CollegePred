<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>College Prediction</title>
  <script src="https://cdn.jsdelivr.net/npm/sql.js@1.8.0/dist/sql-wasm.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-50 p-6">

  <!-- Header -->
  <header class="mb-10 text-center">
    <h1 class="text-4xl font-bold text-gray-800">College Predictor</h1>
    <p class="text-sm text-gray-500 mt-1">Everything calculated here is based upon official cut-off data of the year 2024.</p>
  </header>

  <!-- Filter Form Section -->
  <section id="filterSection" class="max-w-4xl mx-auto mb-10 p-6 bg-white shadow rounded hidden">
    <form id="filterForm" class="space-y-6">
      <div>
        <label for="rank" class="block font-semibold mb-1 text-gray-700">Rank <span class="text-red-500">*</span></label>
        <input type="number" id="rank" name="rank" required class="w-full px-3 py-2 border rounded" />
      </div>

      <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
        <div>
          <label for="institute" class="block font-semibold mb-1">Institute</label>
          <select id="institute" name="institute" class="w-full px-3 py-2 border rounded">
            <option value="">All</option>
          </select>
        </div>

        <div>
          <label for="program" class="block font-semibold mb-1">Program</label>
          <select id="program" name="program" class="w-full px-3 py-2 border rounded">
            <option value="">All</option>
          </select>
        </div>

        <div>
          <label for="quota" class="block font-semibold mb-1">Quota</label>
          <select id="quota" name="quota" class="w-full px-3 py-2 border rounded">
            <option value="">All</option>
          </select>
        </div>

        <div>
          <label for="category" class="block font-semibold mb-1">Category</label>
          <select id="category" name="category" class="w-full px-3 py-2 border rounded">
            <option value="">All</option>
          </select>
        </div>

        <div>
          <label for="round" class="block font-semibold mb-1">Round</label>
          <select id="round" name="round" class="w-full px-3 py-2 border rounded">
            <option value="">All</option>
          </select>
        </div>

        <div>
          <label for="seatGender" class="block font-semibold mb-1">Seat Gender</label>
          <select id="seatGender" name="seatGender" class="w-full px-3 py-2 border rounded">
            <option value="">All</option>
          </select>
        </div>
      </div>

      <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Predict</button>
    </form>
  </section>

  <!-- Results Section -->
  <section id="resultsSection" class="max-w-7xl mx-auto hidden p-6 bg-white shadow rounded overflow-x-auto">
    <div id="results"></div>
  </section>

  <!-- Script Logic -->
  <script>
    (async () => {
      const SQL = await initSqlJs({ locateFile: file => `https://cdn.jsdelivr.net/npm/sql.js@1.8.0/dist/${file}` });

      const response = await fetch("https://evilgeek.github.io/CollegePred/2024.db.gz");
      const compressed = new Uint8Array(await response.arrayBuffer());
      const decompressed = new Uint8Array(pako.ungzip(compressed));
      const db = new SQL.Database(decompressed);
      const currentTable = db.exec(`SELECT name FROM sqlite_master WHERE type='table'`)[0].values[0][0];

      function getUniqueValues(column) {
        const stmt = db.prepare(`SELECT DISTINCT "${column}" FROM "${currentTable}" WHERE "${column}" IS NOT NULL AND "${column}" != '' ORDER BY "${column}" COLLATE NOCASE ASC`);
        const values = [];
        while(stmt.step()) values.push(stmt.get()[0]);
        stmt.free();
        return values;
      }

      function fillSelect(id, values) {
        const select = document.getElementById(id);
        select.innerHTML = '<option value="">All</option>';
        values.forEach(v => {
          const option = document.createElement("option");
          option.value = v;
          option.textContent = v;
          select.appendChild(option);
        });
      }

      ["institute", "program", "quota", "category", "round", "seatGender"].forEach(col => {
        const columnName = {
          institute: "Institute",
          program: "Program",
          quota: "Quota",
          category: "Category",
          round: "Round",
          seatGender: "Seat Gender"
        }[col];
        fillSelect(col, getUniqueValues(columnName));
      });

      document.getElementById("filterSection").classList.remove("hidden");

      document.getElementById("filterForm").onsubmit = function(event) {
        event.preventDefault();

        const rank = Number(document.getElementById("rank").value);
        if (!rank) {
          alert("Please enter a valid rank.");
          return;
        }

        const filters = {
          institute: document.getElementById("institute").value,
          program: document.getElementById("program").value,
          quota: document.getElementById("quota").value,
          category: document.getElementById("category").value,
          round: document.getElementById("round").value,
          seatGender: document.getElementById("seatGender").value
        };

        let query = `SELECT * FROM "${currentTable}" WHERE ? BETWEEN "Opening Rank" AND "Closing Rank"`;
        const params = [rank];

        for (const [key, value] of Object.entries(filters)) {
          if (value) {
            const colName = {
              institute: "Institute",
              program: "Program",
              quota: "Quota",
              category: "Category",
              round: "Round",
              seatGender: "Seat Gender"
            }[key];
            if (["institute", "program"].includes(key)) {
              query += ` AND LOWER("${colName}") LIKE LOWER(?)`;
              params.push(`%${value}%`);
            } else {
              query += ` AND LOWER("${colName}") = LOWER(?)`;
              params.push(value);
            }
          }
        }

        const result = db.exec(query, params);
        const resultsDiv = document.getElementById("results");
        const resultsSection = document.getElementById("resultsSection");

        if (!result.length || !result[0].values.length) {
          resultsDiv.innerHTML = `<p class="text-red-600 font-semibold">No matches found.</p>`;
          resultsSection.classList.remove("hidden");
          return;
        }

        const columns = result[0].columns.filter(c => c !== "Sr.No" && c !== "Remark");
        const values = result[0].values;

        let tableHtml = `<table class="min-w-full border border-gray-300 border-collapse text-sm">
          <thead class="bg-gray-200"><tr><th class="border border-gray-300 px-2 py-1 text-left">#</th>`;
        columns.forEach(col => {
          tableHtml += `<th class="border border-gray-300 px-2 py-1 text-left">${col}</th>`;
        });
        tableHtml += "</tr></thead><tbody>";

        values.forEach((row, idx) => {
          tableHtml += "<tr>";
          tableHtml += `<td class="border border-gray-300 px-2 py-1">${idx + 1}</td>`;
          row.forEach((cell, i) => {
            if (result[0].columns[i] !== "Sr.No" && result[0].columns[i] !== "Remark") {
              tableHtml += `<td class="border border-gray-300 px-2 py-1">${cell}</td>`;
            }
          });
          tableHtml += "</tr>";
        });

        tableHtml += "</tbody></table>";
        resultsDiv.innerHTML = tableHtml;
        resultsSection.classList.remove("hidden");
      };
    })();
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
</body>
</html>
